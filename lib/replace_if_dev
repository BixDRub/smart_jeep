import 'package:flutter/material.dart';
import 'package:flutter_map/flutter_map.dart';
import 'package:latlong2/latlong.dart';
import 'routes.dart';

class DevTestMap extends StatefulWidget {
  const DevTestMap({super.key});

  @override
  State<DevTestMap> createState() => _DevTestMapState();
}

class _DevTestMapState extends State<DevTestMap> {
  final MapController _mapController = MapController();
  LatLng? vehiclePosition;
  late RouteData selectedRoute;
  List<LatLng> touchedPoints = [];

  @override
  void initState() {
    super.initState();
    selectedRoute = allRouteData.first;
    simulateVehicleMovement();
  }

  void simulateVehicleMovement() async {
    for (final point in selectedRoute.coordinates) {
      await Future.delayed(const Duration(seconds: 2));
      if (!mounted) return;
      setState(() => vehiclePosition = point);
    }
  }

  void switchRoute(RouteData route) {
    setState(() {
      selectedRoute = route;
      vehiclePosition = null;
      _mapController.move(route.coordinates.first, 13);
      simulateVehicleMovement();
    });
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        title: const Text("TransitLink â€” DEV"),
        actions: [
          IconButton(
            icon: const Icon(Icons.delete, color: Colors.white),
            tooltip: "Clear touched points",
            onPressed: () => setState(() => touchedPoints.clear()),
          ),
          DropdownButtonHideUnderline(
            child: DropdownButton<RouteData>(
              value: selectedRoute,
              icon: const Icon(Icons.keyboard_arrow_down, color: Colors.white),
              dropdownColor: Colors.blueAccent,
              items: allRouteData.map((route) {
                return DropdownMenuItem<RouteData>(
                  value: route,
                  child: Text(
                    route.name,
                    style: const TextStyle(color: Colors.white),
                  ),
                );
              }).toList(),
              onChanged: (value) {
                if (value != null) switchRoute(value);
              },
            ),
          ),
        ],
      ),
      body: FlutterMap(
        mapController: _mapController,
        options: MapOptions(
          initialCenter: LatLng(13.9, 121.2),
          initialZoom: 13,
          maxZoom: 19,
          onTap: (_, latlng) {
            setState(() => touchedPoints.add(latlng));
            debugPrint("LatLng(${latlng.latitude}, ${latlng.longitude}),");
          },
        ),
        children: [
          TileLayer(
            urlTemplate: "https://tile.openstreetmap.org/{z}/{x}/{y}.png",
            userAgentPackageName: 'com.smart_jeep.capstone',
          ),

      
          PolylineLayer(
            polylines: allRouteData.expand((route) {
              return List.generate(route.lanes.length, (i) {
                return Polyline(
                  points: route.lanes[i],
                  color: route.laneColors[i],
                  strokeWidth: 4,
                  borderColor: Colors.black,
                  borderStrokeWidth: 2,
                );
              });
            }).toList(),
          ),

          // Red line for touched points
          if (touchedPoints.isNotEmpty)
            PolylineLayer(
              polylines: [
                Polyline(
                  points: touchedPoints,
                  color: Colors.red,
                  strokeWidth: 3,
                ),
              ],
            ),

          // Markers for touched points
          if (touchedPoints.isNotEmpty)
            MarkerLayer(
              markers: touchedPoints.asMap().entries.map((entry) {
                return Marker(
                  point: entry.value,
                  width: 30,
                  height: 30,
                  child: Container(
                    decoration: BoxDecoration(
                      color: Colors.red,
                      shape: BoxShape.circle,
                      border: Border.all(color: Colors.red[900]!, width: 2),
                    ),
                    child: Center(
                      child: Text(
                        '${entry.key + 1}',
                        style: const TextStyle(
                          color: Colors.white,
                          fontSize: 12,
                          fontWeight: FontWeight.bold,
                        ),
                      ),
                    ),
                  ),
                );
              }).toList(),
            ),
        
          if (vehiclePosition != null)
            MarkerLayer(
              markers: [
                Marker(
                  point: vehiclePosition!,
                  width: 50,
                  height: 50,
                  child: const Icon(
                    Icons.directions_bus,
                    color: Colors.green,
                    size: 40,
                  ),
                ),
              ],
            ),

       
          MarkerLayer(
            markers: [
              Marker(
                point: selectedRoute
                    .coordinates[(selectedRoute.coordinates.length / 2).floor()],
                width: 140,
                height: 30,
                child: Container(
                  alignment: Alignment.center,
                  decoration: BoxDecoration(
                    color: const Color.fromRGBO(255, 255, 255, 0.85),
                    borderRadius: BorderRadius.circular(4),
                    border: Border.all(color: Colors.black54),
                  ),
                  child: Text(
                    selectedRoute.name,
                    style: const TextStyle(
                      fontSize: 12,
                      fontWeight: FontWeight.bold,
                    ),
                  ),
                ),
              ),
            ],
          ),
        ],
      ),
    );
  }
}





//DO NOTR TOUCHHHHH ==========================
import 'package:flutter/material.dart';
import 'test_map.dart';
void main() {
  runApp(const MyApp());
}

class MyApp extends StatelessWidget {
  const MyApp({super.key});

  @override
  Widget build(BuildContext context) {
    return MaterialApp(
      debugShowCheckedModeBanner: false,
      title: 'GPS Test',
      home: const DevTestMap(),
      routes: {
        '/dev': (context) => const DevTestMap(),
      },
    );
  }
}




//WIDGET TEST
import 'package:flutter_test/flutter_test.dart';
import 'package:smart_jeep/test_map.dart';

void main() {
  testWidgets('Test OSM map loads', (WidgetTester tester) async {
    await tester.pumpWidget(DevTestMap());
    expect(find.byType(DevTestMap), findsOneWidget);
  });
}
